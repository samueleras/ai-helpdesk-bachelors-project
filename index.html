<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test LangChain App</title>
  </head>
  <body>
    <h1>Ask a Question</h1>
    <form id="askForm">
      <label for="question">Enter Question:</label>
      <input
        type="text"
        id="question"
        name="question"
        style="width: 300px; height: 40px; font-size: 18px; padding: 10px"
      />

      <button type="submit">Submit</button>
    </form>
    <p id="response"></p>
    <form id="ticketForm" style="display: none">
      <button id="buttonTicket" type="button">Create Ticket</button>
    </form>

    <script>
      let conversation = [];
      let queryPrompt = "";
      let ticket = false;
      function toggleForm() {
        let form = document.getElementById("ticketForm");
        form.style.display =
          form.style.display === "none" || form.style.display === ""
            ? "block"
            : "none";
      }
      function hideForm() {
        document.getElementById("ticketForm").style.display = "none";
      }
      conversation = [];

      function submit(e, text) {
        e.preventDefault();
        if (ticket) {
          hideForm();
          createTicket(e, text);
          return;
        }

        conversation.push(["human", text]);
        console.log(conversation);
        document.getElementById("response").innerText += "\n\nUser: " + text;

        fetch("http://127.0.0.1:5000/ask", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ conversation }),
        })
          .then((response) => response.json())
          .then((data) => {
            conversation.push(["ai", data.response.llm_output]);
            queryPrompt = data.response.queryPrompt;
            console.log(conversation);
            console.log("QueryPrompt: ", queryPrompt);
            document.getElementById("response").innerText +=
              "\n\nAI: " + data.response.llm_output;
            if (data.response.ticket == true) {
              toggleForm();
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      function createTicket(e, text) {
        e.preventDefault();

        ticket = true;
        conversation.push(["human", text]);

        console.log(conversation);

        fetch("http://127.0.0.1:5000/create_ticket", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ conversation, queryPrompt }),
        })
          .then((response) => response.json())
          .then((data) => {
            conversation.push(["ai", data.response.llm_output]);
            console.log(conversation);
            document.getElementById("response").innerText +=
              typeof data.response.llm_output === "string"
                ? "AI: " + data.response.llm_output
                : "Ticket: " + data.response.llm_output.ticket_content;
          })
          .catch((error) => console.error("Error:", error));
      }

      document
        .getElementById("askForm")
        .addEventListener("submit", (e) =>
          submit(e, document.getElementById("question").value)
        );

      document
        .getElementById("buttonTicket")
        .addEventListener("click", (e) =>
          createTicket(e, "Please create a ticket for me.")
        );
    </script>
  </body>
</html>
